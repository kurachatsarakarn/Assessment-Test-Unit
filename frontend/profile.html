<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Profile</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="js/main.js"></script>
  <style>
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout-btn {
      background: crimson;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: darkred;
    }
    #editForm input[readonly] {
      background: #eee;
      cursor: not-allowed;
    }
    #editForm button {
      margin-top: 10px;
    }
    #editForm input {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="profile-header">
      <h1>โปรไฟล์</h1>
      <button id="logout" class="logout-btn">Logout</button>
    </div>
    <div id="profile" class="profile-box"></div>

    <form id="editForm">
      username<input name="username" placeholder="Username" readonly />
      fullname<input name="fullname" placeholder="Full name" readonly />
      <div>
        <button type="button" id="editBtn">แก้ไข</button>
        <button type="submit" id="saveBtn" disabled>บันทึก</button>
      </div>
    </form>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "login.html";
    }

    function loadProfile() {
      getProfile(
        token,
        (res) => {
          $("#profile").html(`
            <strong>Email:</strong> ${res.user.email}<br>
          `);
          $("#editForm [name=username]").val(res.user.username || "");
          $("#editForm [name=fullname]").val(res.user.fullname || "");
        },
        (err) => {
          alert(err);
          localStorage.clear();
          window.location.href = "login.html";
        }
      );
    }

    // Edit button
    $("#editBtn").on("click", function () {
      $("#editForm input").prop("readonly", false).css({"background":"white", "cursor":"text"});
      $("#saveBtn").prop("disabled", false);
      $(this).prop("disabled", true);
    });

    // Save changes
    $("#editForm").on("submit", function(e){
      e.preventDefault();
      const data = {
        username: this.username.value,
        fullname: this.fullname.value
      };
      updateProfile(
        token,
        data,
        () => {
          alert("บันทึกสำเร็จ!");
          loadProfile();
          $("#editForm input").prop("readonly", true).css({"background":"#eee","cursor":"not-allowed"});
          $("#saveBtn").prop("disabled", true);
          $("#editBtn").prop("disabled", false);
        },
        (err) => alert(err)
      );
    });

    // Logout
    $("#logout").on("click", () => {
      localStorage.clear();
      window.location.href = "login.html";
    });

    loadProfile();

    // JS function: updateProfile
    function updateProfile(token, data, onSuccess, onError) {
      $.ajax({
        url: `${API_URL}/profile`,
        method: "PUT",
        headers: { Authorization: "Bearer " + token },
        contentType: "application/json",
        data: JSON.stringify(data),
        success: onSuccess,
        error: (xhr) => onError(xhr.responseJSON?.error || "Error")
      });
    }

    // JS function: getProfile
    function getProfile(token, onSuccess, onError) {
      $.ajax({
        url: `${API_URL}/profile`,
        method: "GET",
        headers: { Authorization: "Bearer " + token },
        success: onSuccess,
        error: (xhr) => onError(xhr.responseJSON?.error || "Error")
      });
    }
  </script>
</body>
</html>
